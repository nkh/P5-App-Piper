#!/bin/bash

# ph - Colorize stdin using piper with predefined color schemes
# Usage: ph [-l] [-r] [-i INDEX] [patterns...]
#   -l           List colors with test patterns
#   -r           Start at random color index
#   -i INDEX     Start at specific color index
#   patterns     Patterns to colorize (pass -g options directly to piper)

show_usage()
	{
	cat << 'EOF'
Usage: ph [-l] [-r] [-i INDEX] [patterns...]
  -l           List colors with test patterns
  -r           Start at random color index (0-5)
  -i INDEX     Start at specific color index
  -h           Show this help
  patterns     Patterns to colorize (pass -g options directly to piper)
EOF
	exit 0
	}

# Define color palette
colors=(
	'rgb444 on_ansi29'
	'rgb444 on_ansi88'
	'rgb444 on_ansi166'
	'rgb444 on_ansi23'
	'rgb444 on_ansi52'
	'rgb444 on_ansi94'
	'rgb444 on_ansi55'
	'rgb444 on_ansi31'
	'rgb444 on_ansi66'
	'rgb444 on_ansi127'
	'rgb444 on_ansi30'
	'rgb444 on_ansi124'
	'rgb444 on_rgb113'
	'rgb333 on_ansi20'
	'rgb444 on_ansi130'
	'rgb444 on_ansi92'
	'rgb444 on_ansi60'
	'rgb444 on_ansi27'
	'rgb444 on_rgb124'
	'rgb444 on_ansi58'
	'rgb444 on_rgb101'
)

color_count="${#colors[@]}"

list_mode=0 color_index=0
piper_args=() piper_options=()

# Parse command line options
while [[ $# -gt 0 ]] ; do
	case "$1" in
		-l) list_mode=1 ; shift ;;
		-r) color_index=$((RANDOM % color_count)) ; shift ;;
		-i) if [[ -z "$2" || ! "$2" =~ ^[0-9]+$ ]] ; then
				echo "Error: -i requires a numeric argument" >&2
				exit 1
			fi
			
			color_index="$2"
			shift 2
			;;
		-h|--help) show_usage ;;
		*) break ;;
	esac
done

# Validate color index
[[ $color_index -ge $color_count ]] && color_index=0

# Generate entries for list mode
if [[ $list_mode -eq 1 ]] ; then
	entries=()
	
	for i in $(seq 0 $((color_count - 1))) ; do
		entries+=("${i}_test")
	done
else
	entries=("$@")
fi

# Build piper arguments
for pattern in "${entries[@]}" ; do
	if [[ "$pattern" == "-g" ]] ; then
		piper_options+=("$pattern")
	else
		if [[ $list_mode -eq 1 ]] ; then
			piper_args+=("^$pattern" "${colors[color_index]}")
		else
			piper_args+=("$pattern" "${colors[color_index]}")
		fi
		
		color_index=$(((color_index + 1) % color_count))
	fi
done

# Execute piper
if [[ $list_mode -eq 1 ]] ; then
	printf "%s\n" "${entries[@]}" | piper "${piper_options[@]}" "${piper_args[@]}"
else
	piper "${piper_options[@]}" "${piper_args[@]}"
fi

# vim: set ft=bash

